import router from '@ohos.router'
import { get, post } from '../utils/HttpUtil'
import { toast, toastErr } from '../utils/ToastUtil'

interface TestamentItem {
  id: number
  title: string
  testamentType: number
  unlockStatus: number
  visibility: number
  createTime: string
}

interface TypeOption {
  idx: number
  label: string
}

const TYPE_LABELS: string[] = ['', 'æ–‡å­—é—è¨€', 'è‡´ç‰¹å®šäºº', 'è´¢äº§åˆ†é…', 'å¿ƒæ„¿æ¸…å•']
const TYPE_COLORS: string[] = ['', '#667EEA', '#10B981', '#F59E0B', '#EF4444']
const TYPE_OPTIONS: TypeOption[] = [
  { idx: 1, label: 'æ–‡å­—é—è¨€' },
  { idx: 2, label: 'è‡´ç‰¹å®šäºº' },
  { idx: 3, label: 'è´¢äº§åˆ†é…' }
]

@Entry
@Component
struct Testament {
  @State list: TestamentItem[] = []
  @State loading: boolean = false
  @State showCreate: boolean = false
  @State newTitle: string = ''
  @State newContent: string = ''
  @State newType: number = 1
  @State creating: boolean = false

  aboutToAppear(): void { this.loadList() }

  async loadList(): Promise<void> {
    this.loading = true
    try {
      const data = await get<TestamentItem[]>('/v1/testament/my')
      this.list = data || []
    } catch (e) {
    } finally {
      this.loading = false
    }
  }

  async createTestament(): Promise<void> {
    if (!this.newTitle.trim()) { toastErr('è¯·å¡«å†™é—è¨€æ ‡é¢˜'); return }
    if (!this.newContent.trim()) { toastErr('è¯·å¡«å†™é—è¨€å†…å®¹'); return }
    this.creating = true
    try {
      await post('/v1/testament/create', {
        title: this.newTitle, content: this.newContent,
        testamentType: this.newType, visibility: 0
      })
      toast('é—è¨€å·²åŠ å¯†ä¿å­˜')
      this.showCreate = false
      this.newTitle = ''
      this.newContent = ''
      this.newType = 1
      this.loadList()
    } catch (e) {
      toastErr((e as Error).message)
    } finally {
      this.creating = false
    }
  }

  typeLabel(t: number): string {
    return (t >= 0 && t < TYPE_LABELS.length) ? TYPE_LABELS[t] : 'å…¶ä»–'
  }

  typeColor(t: number): string {
    return (t >= 0 && t < TYPE_COLORS.length) ? TYPE_COLORS[t] : '#9CA3AF'
  }

  build() {
    Column() {
      Row() {
        Text('â†').fontSize(22).fontColor('#1A1A2E').onClick(() => { router.back() })
        Text('ç”Ÿå‰é—è¨€').fontSize(18).fontWeight(FontWeight.Bold).fontColor('#1A1A2E')
          .layoutWeight(1).textAlign(TextAlign.Center)
        Text('+ æ–°å»º').fontSize(14).fontColor('#667EEA').fontWeight(FontWeight.Medium)
          .onClick(() => { this.showCreate = !this.showCreate })
      }
      .width('100%').height(56).padding({ left: 16, right: 16 })

      // åˆ›å»ºé¢æ¿
      if (this.showCreate) {
        Column({ space: 12 }) {
          Text('åˆ›å»ºæ–°é—è¨€').fontSize(15).fontWeight(FontWeight.Bold).fontColor('#1A1A2E')

          Row({ space: 6 }) {
            ForEach(TYPE_OPTIONS, (item: TypeOption) => {
              Text(item.label)
                .fontSize(12)
                .fontColor(this.newType === item.idx ? Color.White : '#667EEA')
                .backgroundColor(this.newType === item.idx ? '#667EEA' : '#EEF0FF')
                .padding({ left: 12, right: 12, top: 6, bottom: 6 })
                .borderRadius(8)
                .onClick(() => { this.newType = item.idx })
            })
          }

          TextInput({ placeholder: 'é—è¨€æ ‡é¢˜', text: this.newTitle })
            .height(44).borderRadius(10).backgroundColor('#F8F9FE').fontSize(14)
            .onChange((v: string) => { this.newTitle = v })

          TextArea({ placeholder: 'å†™ä¸‹æ‚¨çš„é—è¨€å†…å®¹...', text: this.newContent })
            .height(100).borderRadius(10).backgroundColor('#F8F9FE').fontSize(14)
            .onChange((v: string) => { this.newContent = v })

          Row({ space: 10 }) {
            Button('å–æ¶ˆ', { type: ButtonType.Normal })
              .layoutWeight(1).height(42)
              .backgroundColor('#F5F5F5').fontColor('#6B7280').borderRadius(10)
              .onClick(() => { this.showCreate = false })
            Button(this.creating ? 'ä¿å­˜ä¸­...' : 'åŠ å¯†ä¿å­˜', { type: ButtonType.Normal })
              .layoutWeight(1).height(42)
              .linearGradient({ angle: 90, colors: [['#667EEA', 0], ['#764BA2', 1]] })
              .fontColor(Color.White).borderRadius(10)
              .enabled(!this.creating)
              .onClick(() => { this.createTestament() })
          }
        }
        .width('100%').padding(16)
        .backgroundColor(Color.White)
        .border({ width: { bottom: 1 }, color: '#F0F0F0' })
      }

      // è¯´æ˜æ¨ªå¹…
      Row({ space: 8 }) {
        Text('ğŸ”’').fontSize(16)
        Text('é—è¨€å†…å®¹åŠ å¯†å­˜å‚¨ï¼Œä»…åœ¨ç¦»ä¸–ç¡®è®¤åå‘æŒ‡å®šæ¥æ”¶äººå¼€æ”¾')
          .fontSize(12).fontColor('#6B7280').layoutWeight(1)
      }
      .width('100%').padding({ left: 16, right: 16, top: 10, bottom: 10 })
      .backgroundColor('#FAFBFF')

      if (this.loading) {
        Column() { LoadingProgress().width(44).height(44).color('#667EEA') }
          .width('100%').layoutWeight(1).justifyContent(FlexAlign.Center)
      } else if (this.list.length === 0) {
        Column({ space: 12 }) {
          Text('ğŸ“').fontSize(52)
          Text('è¿˜æ²¡æœ‰é—è¨€').fontSize(16).fontColor('#9CA3AF')
          Text('åœ¨è¿™é‡Œè®°å½•æ‚¨çš„å¿ƒæ„¿ä¸å˜±æ‰˜\nåŠ å¯†ä¿å­˜ï¼Œå®‰å…¨å¯é ')
            .fontSize(13).fontColor('#C0C4CC').textAlign(TextAlign.Center)
        }
        .width('100%').layoutWeight(1).justifyContent(FlexAlign.Center)
      } else {
        List({ space: 12 }) {
          ForEach(this.list, (item: TestamentItem) => {
            ListItem() {
              Column({ space: 10 }) {
                Row({ space: 8 }) {
                  Text(this.typeLabel(item.testamentType))
                    .fontSize(11).fontColor(this.typeColor(item.testamentType))
                    .padding({ left: 8, right: 8, top: 3, bottom: 3 })
                    .backgroundColor(this.typeColor(item.testamentType) + '1A').borderRadius(6)
                  Blank()
                  Row({ space: 4 }) {
                    Text(item.unlockStatus === 1 ? 'ğŸ”“' : 'ğŸ”’').fontSize(14)
                    Text(item.unlockStatus === 1 ? 'å·²è§£é”' : 'é”å®šä¸­')
                      .fontSize(11).fontColor(item.unlockStatus === 1 ? '#10B981' : '#9CA3AF')
                  }
                }
                Text(item.title)
                  .fontSize(16).fontWeight(FontWeight.Medium).fontColor('#1A1A2E')
                Text(item.createTime?.substring(0, 10) || '')
                  .fontSize(11).fontColor('#C0C4CC')
              }
              .width('100%').padding(16)
              .backgroundColor(Color.White).borderRadius(16)
              .shadow({ radius: 6, color: '#0000000D', offsetX: 0, offsetY: 3 })
            }
          })
        }
        .padding({ left: 16, right: 16, top: 8 })
        .layoutWeight(1)
      }
    }
    .width('100%').height('100%').backgroundColor('#F8F9FE')
  }
}
