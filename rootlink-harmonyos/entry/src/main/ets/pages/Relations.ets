import router from '@ohos.router'
import { get, post } from '../utils/HttpUtil'
import { toast, toastErr } from '../utils/ToastUtil'

interface RelationItem {
  relationId: number
  relatedUserId: number
  relationDesc: string
  realName: string
  lifeStatus: number
  phone: string
}

interface PendingItem {
  id: number
  applicantName: string
  relationDesc: string
  reason: string
}

interface SearchUser {
  userId: number
  realName: string
  phone: string
}

const REL_OPTIONS: string[] = ['å„¿å­','å¥³å„¿','çˆ¶äº²','æ¯äº²','é…å¶','å“¥å“¥','å¼Ÿå¼Ÿ','å§å§','å¦¹å¦¹']
const REL_CHAINS: string[][] = [['å­'],['å¥³'],['çˆ¶'],['æ¯'],['é…å¶'],['åŒè¾ˆ','ç›´å±','å“¥'],
  ['åŒè¾ˆ','ç›´å±','å¼Ÿ'],['åŒè¾ˆ','ç›´å±','å§'],['åŒè¾ˆ','ç›´å±','å¦¹']]

@Entry
@Component
struct Relations {
  @State tab: number = 0
  @State relations: RelationItem[] = []
  @State pending: PendingItem[] = []
  @State loading: boolean = false
  @State searchIdCard: string = ''
  @State searchResult: SearchUser | null = null
  @State searching: boolean = false
  @State showAdd: boolean = false
  @State relIdx: number = 0
  @State addReason: string = ''

  aboutToAppear(): void {
    this.loadData()
  }

  async loadData(): Promise<void> {
    this.loading = true
    try {
      const data = await get<RelationItem[]>('/v1/relation/my')
      this.relations = data || []
      const pd = await get<PendingItem[]>('/v1/relation/apply/pending')
      this.pending = pd || []
    } catch (e) {
    } finally {
      this.loading = false
    }
  }

  async searchUser(): Promise<void> {
    if (this.searchIdCard.length < 15) { toastErr('è¯·è¾“å…¥å®Œæ•´èº«ä»½è¯å·'); return }
    this.searching = true
    try {
      const r = await get<SearchUser>(`/v1/relation/search?idCard=${this.searchIdCard}`)
      this.searchResult = r
    } catch (e) {
      toastErr((e as Error).message)
    } finally {
      this.searching = false
    }
  }

  async applyRelation(): Promise<void> {
    if (!this.searchResult) { return }
    try {
      await post('/v1/relation/apply', {
        targetUserId: this.searchResult.userId,
        relationChain: JSON.stringify(REL_CHAINS[this.relIdx]),
        reason: this.addReason
      })
      toast('ç”³è¯·å·²å‘é€ï¼Œç­‰å¾…å¯¹æ–¹ç¡®è®¤')
      this.showAdd = false
      this.searchResult = null
      this.searchIdCard = ''
    } catch (e) {
      toastErr((e as Error).message)
    }
  }

  async handlePending(id: number, action: number): Promise<void> {
    try {
      await post(`/v1/relation/apply/${id}/handle`, { action })
      toast(action === 1 ? 'å·²åŒæ„' : 'å·²æ‹’ç»')
      this.loadData()
    } catch (e) {
      toastErr((e as Error).message)
    }
  }

  build() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Text('â†').fontSize(22).fontColor('#1A1A2E').onClick(() => { router.back() })
        Text('äº²å±å…³ç³»').fontSize(18).fontWeight(FontWeight.Bold).fontColor('#1A1A2E')
          .layoutWeight(1).textAlign(TextAlign.Center)
        Text('+ æ·»åŠ ').fontSize(14).fontColor('#667EEA').fontWeight(FontWeight.Medium)
          .onClick(() => { this.showAdd = !this.showAdd })
      }
      .width('100%').height(56).padding({ left: 16, right: 16 })

      // æ·»åŠ é¢æ¿
      if (this.showAdd) {
        Column({ space: 10 }) {
          Row({ space: 8 }) {
            TextInput({ placeholder: 'è¾“å…¥å¯¹æ–¹èº«ä»½è¯å·æœç´¢', text: this.searchIdCard })
              .layoutWeight(1).height(44).borderRadius(10)
              .backgroundColor('#F8F9FE').fontSize(14)
              .onChange((v: string) => { this.searchIdCard = v })
            Button('æœç´¢', { type: ButtonType.Normal })
              .height(44).padding({ left: 16, right: 16 })
              .backgroundColor('#667EEA').fontColor(Color.White)
              .borderRadius(10).fontSize(14)
              .onClick(() => { this.searchUser() })
          }

          if (this.searchResult !== null) {
            Column({ space: 8 }) {
              Row({ space: 10 }) {
                Stack() {
                  Circle().width(40).height(40).fill('#667EEA')
                  Text(this.searchResult!.realName?.charAt(0) || '?')
                    .fontSize(16).fontColor(Color.White)
                }
                Column({ space: 2 }) {
                  Text(this.searchResult!.realName).fontSize(15).fontWeight(FontWeight.Medium)
                  Text(this.searchResult!.phone).fontSize(12).fontColor('#9CA3AF')
                }
                .layoutWeight(1).alignItems(HorizontalAlign.Start)
              }

              // å…³ç³»é€‰æ‹©
              Row({ space: 8 }) {
                Text('æˆ‘çš„').fontSize(13).fontColor('#6B7280')
                Select(REL_OPTIONS.map(v => ({ value: v })))
                  .selected(this.relIdx)
                  .value(REL_OPTIONS[this.relIdx])
                  .font({ size: 14 }).fontColor('#1A1A2E')
                  .layoutWeight(1)
                  .onSelect((idx: number) => { this.relIdx = idx })
              }

              TextInput({ placeholder: 'ç”³è¯·ç†ç”±ï¼ˆé€‰å¡«ï¼‰' })
                .height(44).borderRadius(10).backgroundColor('#F8F9FE').fontSize(14)
                .onChange((v: string) => { this.addReason = v })

              Button('å‘é€ç”³è¯·', { type: ButtonType.Normal })
                .width('100%').height(44)
                .backgroundColor('#667EEA').fontColor(Color.White)
                .borderRadius(10).fontSize(14)
                .onClick(() => { this.applyRelation() })
            }
            .width('100%').padding(12)
            .backgroundColor(Color.White).borderRadius(12)
            .border({ width: 1, color: '#E5E7EB' })
          }
        }
        .width('100%').padding({ left: 16, right: 16, bottom: 10 })
        .backgroundColor(Color.White)
        .border({ width: { bottom: 1 }, color: '#F0F0F0' })
      }

      // Tab
      Row() {
        Column() {
          Text('æˆ‘çš„äº²å±')
            .fontSize(14)
            .fontWeight(this.tab === 0 ? FontWeight.Medium : FontWeight.Normal)
            .fontColor(this.tab === 0 ? '#667EEA' : '#9CA3AF')
          if (this.tab === 0) {
            Divider().color('#667EEA').strokeWidth(2).width(40)
          }
        }
        .layoutWeight(1).height(44).justifyContent(FlexAlign.Center)
        .onClick(() => { this.tab = 0 })

        Column() {
          Text(`å¾…å¤„ç†(${this.pending.length})`)
            .fontSize(14)
            .fontWeight(this.tab === 1 ? FontWeight.Medium : FontWeight.Normal)
            .fontColor(this.tab === 1 ? '#667EEA' : '#9CA3AF')
          if (this.tab === 1) {
            Divider().color('#667EEA').strokeWidth(2).width(40)
          }
        }
        .layoutWeight(1).height(44).justifyContent(FlexAlign.Center)
        .onClick(() => { this.tab = 1 })
      }
      .width('100%').backgroundColor(Color.White)
      .border({ width: { bottom: 1 }, color: '#F0F0F0' })

      // åˆ—è¡¨
      if (this.tab === 0) {
        if (this.relations.length === 0) {
          Column({ space: 12 }) {
            Text('ğŸŒ±').fontSize(48)
            Text('è¿˜æ²¡æœ‰äº²å±å…³ç³»').fontSize(15).fontColor('#9CA3AF')
          }
          .width('100%').layoutWeight(1).justifyContent(FlexAlign.Center)
        } else {
          List({ space: 10 }) {
            ForEach(this.relations, (r: RelationItem) => {
              ListItem() {
                Row({ space: 12 }) {
                  Stack() {
                    Circle().width(48).height(48)
                      .linearGradient({ angle: 135, colors: [['#667EEA', 0], ['#764BA2', 1]] })
                    Text(r.realName?.charAt(0) || '?').fontSize(18).fontColor(Color.White)
                  }
                  Column({ space: 4 }) {
                    Row({ space: 6 }) {
                      Text(r.realName || 'æœªçŸ¥')
                        .fontSize(15).fontWeight(FontWeight.Medium).fontColor('#1A1A2E')
                      if (r.lifeStatus === 3) {
                        Text('å·²ç¦»ä¸–').fontSize(10).fontColor('#EF4444')
                          .padding({ left: 6, right: 6, top: 2, bottom: 2 })
                          .backgroundColor('#FEE2E2').borderRadius(4)
                      }
                    }
                    Text(r.relationDesc || 'äº²å±').fontSize(12).fontColor('#9CA3AF')
                  }
                  .layoutWeight(1).alignItems(HorizontalAlign.Start)
                }
                .width('100%').padding(14)
                .backgroundColor(Color.White).borderRadius(14)
                .shadow({ radius: 4, color: '#0000000A', offsetX: 0, offsetY: 2 })
              }
            })
          }
          .padding({ left: 16, right: 16, top: 10 })
          .layoutWeight(1)
        }
      } else {
        if (this.pending.length === 0) {
          Column({ space: 12 }) {
            Text('âœ…').fontSize(48)
            Text('æ²¡æœ‰å¾…å¤„ç†ç”³è¯·').fontSize(15).fontColor('#9CA3AF')
          }
          .width('100%').layoutWeight(1).justifyContent(FlexAlign.Center)
        } else {
          List({ space: 10 }) {
            ForEach(this.pending, (p: PendingItem) => {
              ListItem() {
                Column({ space: 10 }) {
                  Row({ space: 8 }) {
                    Stack() {
                      Circle().width(40).height(40).fill('#E0E7FF')
                      Text(p.applicantName?.charAt(0) || '?').fontSize(16).fontColor('#667EEA')
                    }
                    Column({ space: 2 }) {
                      Text(p.applicantName)
                        .fontSize(15).fontWeight(FontWeight.Medium).fontColor('#1A1A2E')
                      Text(`ç”³è¯·æˆä¸ºæ‚¨çš„ã€Œ${p.relationDesc}ã€`)
                        .fontSize(12).fontColor('#6B7280')
                    }
                    .layoutWeight(1).alignItems(HorizontalAlign.Start)
                  }
                  if (p.reason) {
                    Text(`"${p.reason}"`)
                      .fontSize(12).fontColor('#9CA3AF').fontStyle(FontStyle.Italic)
                  }
                  Row({ space: 10 }) {
                    Button('æ‹’ç»', { type: ButtonType.Normal })
                      .layoutWeight(1).height(36)
                      .backgroundColor('#FEF2F2').fontColor('#EF4444').borderRadius(8).fontSize(14)
                      .onClick(() => { this.handlePending(p.id, 2) })
                    Button('åŒæ„', { type: ButtonType.Normal })
                      .layoutWeight(1).height(36)
                      .backgroundColor('#667EEA').fontColor(Color.White).borderRadius(8).fontSize(14)
                      .onClick(() => { this.handlePending(p.id, 1) })
                  }
                }
                .width('100%').padding(14)
                .backgroundColor(Color.White).borderRadius(14)
                .shadow({ radius: 4, color: '#0000000A', offsetX: 0, offsetY: 2 })
              }
            })
          }
          .padding({ left: 16, right: 16, top: 10 })
          .layoutWeight(1)
        }
      }
    }
    .width('100%').height('100%').backgroundColor('#F8F9FE')
  }
}
