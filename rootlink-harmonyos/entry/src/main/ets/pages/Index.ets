import router from '@ohos.router'
import { get } from '../utils/HttpUtil'
import { load, clear } from '../utils/StorageUtil'
import { STORAGE_USER, STORAGE_TOKEN } from '../utils/Constants'

interface StatItem {
  label: string
  val: number
  icon: string
}

interface QuickItem {
  icon: string
  label: string
  color: string
  page: string
}

interface RelationItem {
  relationId: number
  relatedUserId: number
  relationDesc: string
  realName: string
  lifeStatus: number
  phone: string
}

interface TestamentItem {
  id: number
  title: string
  testamentType: number
  unlockStatus: number
  createTime: string
}

interface MenuItem {
  icon: string
  label: string
  page: string
}

// â”€â”€â”€ é¦–é¡µ Tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@Component
struct DashboardTab {
  @State userName: string = 'å®¶æ—æˆå‘˜'
  @State relCount: number = 0
  @State pendingCount: number = 0

  aboutToAppear(): void {
    this.loadUser()
  }

  async loadUser(): Promise<void> {
    try {
      const str = await load(getContext(this) as Context, STORAGE_USER)
      if (str) {
        const u = JSON.parse(str) as Record<string, string>
        this.userName = u['realName'] || 'å®¶æ—æˆå‘˜'
      }
    } catch (e) {}
  }

  build() {
    Scroll() {
      Column({ space: 0 }) {
        // æ¸å˜å¤´éƒ¨
        Column({ space: 16 }) {
          Row() {
            Column({ space: 4 }) {
              Text(`ä½ å¥½ï¼Œ${this.userName}`)
                .fontSize(22).fontWeight(FontWeight.Bold).fontColor(Color.White)
              Text('æ¬¢è¿å›åˆ° RootLink')
                .fontSize(13).fontColor('#E0D7FF')
            }
            .alignItems(HorizontalAlign.Start)
            .layoutWeight(1)

            Stack() {
              Circle().width(44).height(44).fill(Color.White).opacity(0.2)
              Text('ğŸ””').fontSize(20)
            }
          }
          .width('100%')

          Row() {
            ForEach([
              { label: 'äº²å±æˆå‘˜', val: this.relCount, icon: 'ğŸ‘¥' } as StatItem,
              { label: 'å¾…ç¡®è®¤', val: this.pendingCount, icon: 'â³' } as StatItem,
              { label: 'é—è¨€', val: 0, icon: 'ğŸ“' } as StatItem
            ], (item: StatItem) => {
              Column({ space: 4 }) {
                Text(item.icon).fontSize(20)
                Text(item.val.toString())
                  .fontSize(24).fontWeight(FontWeight.Bold).fontColor(Color.White)
                Text(item.label).fontSize(11).fontColor('#E0D7FF')
              }
              .layoutWeight(1)
              .alignItems(HorizontalAlign.Center)
            })
          }
          .width('100%')
        }
        .width('100%')
        .padding(20)
        .linearGradient({ angle: 135, colors: [['#667EEA', 0], ['#764BA2', 1]] })

        // å¿«æ·å…¥å£
        Column({ space: 12 }) {
          Text('å¿«æ·æ“ä½œ')
            .fontSize(16).fontWeight(FontWeight.Bold).fontColor('#1A1A2E')
            .width('100%')
            .margin({ top: 4 })

          Grid() {
            ForEach([
              { icon: 'â•', label: 'æ·»åŠ äº²å±', color: '#667EEA', page: 'pages/Relations' } as QuickItem,
              { icon: 'ğŸŒ³', label: 'å…³ç³»æ ‘',   color: '#10B981', page: 'pages/FamilyTree' } as QuickItem,
              { icon: 'âœï¸', label: 'å†™é—è¨€',   color: '#F59E0B', page: 'pages/Testament' } as QuickItem,
              { icon: 'ğŸ›ï¸', label: 'æŒ½è”å¢™',   color: '#EF4444', page: 'pages/EulogyWall' } as QuickItem
            ], (item: QuickItem) => {
              GridItem() {
                Column({ space: 8 }) {
                  Stack() {
                    Circle().width(48).height(48).fill(item.color).opacity(0.12)
                    Text(item.icon).fontSize(22)
                  }
                  Text(item.label)
                    .fontSize(13).fontColor('#1A1A2E').fontWeight(FontWeight.Medium)
                }
                .width('100%').height(88)
                .backgroundColor(Color.White).borderRadius(16)
                .justifyContent(FlexAlign.Center)
                .shadow({ radius: 4, color: '#0000000A', offsetX: 0, offsetY: 2 })
                .onClick(() => { router.pushUrl({ url: item.page }) })
              }
            })
          }
          .columnsTemplate('1fr 1fr')
          .columnsGap(12).rowsGap(12)
          .width('100%')

          Column({ space: 10 }) {
            Text('RootLink ä½¿å‘½')
              .fontSize(14).fontWeight(FontWeight.Bold).fontColor('#1A1A2E')
            Text('ç”¨æ•°å­—æ–¹å¼è®°å½•å®¶æ—å…³ç³»ï¼Œä¼ é€’äº²æƒ…ä¸è®°å¿†ã€‚æ”¯æŒäº²å±å…³ç³»æ¨æ–­ã€ç”Ÿå‰é—è¨€åŠ å¯†ä¿ç®¡ã€æŒ½è”å®¡æ ¸å‘å¸ƒç­‰åŠŸèƒ½ã€‚')
              .fontSize(13).fontColor('#6B7280').lineHeight(20)
          }
          .width('100%').padding(16)
          .backgroundColor(Color.White).borderRadius(16)
          .shadow({ radius: 4, color: '#0000000A', offsetX: 0, offsetY: 2 })
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 16, bottom: 24 })
      }
    }
    .width('100%').height('100%').backgroundColor('#F8F9FE')
  }
}

// â”€â”€â”€ å…³ç³» Tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@Component
struct RelationsTab {
  @State relations: RelationItem[] = []
  @State loading: boolean = false

  aboutToAppear(): void {
    this.loadData()
  }

  async loadData(): Promise<void> {
    this.loading = true
    try {
      const data = await get<RelationItem[]>('/v1/relation/my')
      this.relations = data || []
    } catch (e) {
    } finally {
      this.loading = false
    }
  }

  build() {
    Column() {
      Row() {
        Text('äº²å±å…³ç³»')
          .fontSize(18).fontWeight(FontWeight.Bold).fontColor('#1A1A2E')
        Blank()
        Text('+ æ·»åŠ ')
          .fontSize(14).fontColor('#667EEA').fontWeight(FontWeight.Medium)
          .onClick(() => { router.pushUrl({ url: 'pages/Relations' }) })
      }
      .width('100%').height(56).padding({ left: 16, right: 16 })

      if (this.loading) {
        Column() {
          LoadingProgress().width(40).height(40).color('#667EEA')
        }
        .width('100%').layoutWeight(1).justifyContent(FlexAlign.Center)
      } else if (this.relations.length === 0) {
        Column({ space: 12 }) {
          Text('ğŸŒ±').fontSize(48)
          Text('è¿˜æ²¡æœ‰äº²å±å…³ç³»').fontSize(16).fontColor('#9CA3AF')
          Text('ç‚¹å‡»ã€Œ+ æ·»åŠ ã€æœç´¢å¹¶æ·»åŠ å®¶æ—æˆå‘˜').fontSize(13).fontColor('#C0C4CC')
        }
        .width('100%').layoutWeight(1).justifyContent(FlexAlign.Center)
      } else {
        List({ space: 10 }) {
          ForEach(this.relations, (r: RelationItem) => {
            ListItem() {
              Row({ space: 12 }) {
                Stack() {
                  Circle().width(44).height(44)
                    .linearGradient({ angle: 135, colors: [['#667EEA', 0], ['#764BA2', 1]] })
                  Text(r.realName?.charAt(0) || '?')
                    .fontSize(18).fontColor(Color.White)
                }
                Column({ space: 4 }) {
                  Row({ space: 6 }) {
                    Text(r.realName || 'æœªçŸ¥')
                      .fontSize(15).fontWeight(FontWeight.Medium).fontColor('#1A1A2E')
                    if (r.lifeStatus === 3) {
                      Text('å·²ç¦»ä¸–')
                        .fontSize(10).fontColor('#EF4444')
                        .padding({ left: 6, right: 6, top: 2, bottom: 2 })
                        .backgroundColor('#FEE2E2').borderRadius(4)
                    }
                  }
                  Text(r.relationDesc || 'äº²å±').fontSize(12).fontColor('#9CA3AF')
                }
                .layoutWeight(1).alignItems(HorizontalAlign.Start)

                Text('â€º').fontSize(18).fontColor('#C0C4CC')
              }
              .width('100%').padding(14)
              .backgroundColor(Color.White).borderRadius(14)
              .shadow({ radius: 4, color: '#0000000A', offsetX: 0, offsetY: 2 })
            }
          })
        }
        .padding({ left: 16, right: 16 })
        .layoutWeight(1)

        Row({ space: 8 }) {
          Text('ğŸŒ³').fontSize(16)
          Text('æŸ¥çœ‹å®Œæ•´å…³ç³»æ ‘').fontSize(14).fontColor('#667EEA').fontWeight(FontWeight.Medium)
          Text('â€º').fontSize(14).fontColor('#667EEA')
        }
        .width('100%').height(48)
        .backgroundColor(Color.White)
        .justifyContent(FlexAlign.Center)
        .border({ width: { top: 1 }, color: '#F0F0F0' })
        .onClick(() => { router.pushUrl({ url: 'pages/FamilyTree' }) })
      }
    }
    .width('100%').height('100%').backgroundColor('#F8F9FE')
  }
}

// â”€â”€â”€ é—è¨€ Tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@Component
struct TestamentTab {
  @State testaments: TestamentItem[] = []
  @State loading: boolean = false

  aboutToAppear(): void {
    this.loadData()
  }

  async loadData(): Promise<void> {
    this.loading = true
    try {
      const data = await get<TestamentItem[]>('/v1/testament/my')
      this.testaments = data || []
    } catch (e) {
    } finally {
      this.loading = false
    }
  }

  typeLabel(t: number): string {
    const labels: string[] = ['', 'æ–‡å­—é—è¨€', 'è‡´ç‰¹å®šäºº', 'è´¢äº§åˆ†é…', 'å¿ƒæ„¿æ¸…å•']
    return t >= 0 && t < labels.length ? labels[t] : 'å…¶ä»–'
  }

  typeColor(t: number): string {
    const colors: string[] = ['', '#667EEA', '#10B981', '#F59E0B', '#EF4444']
    return t >= 0 && t < colors.length ? colors[t] : '#9CA3AF'
  }

  build() {
    Column() {
      Row() {
        Text('ç”Ÿå‰é—è¨€').fontSize(18).fontWeight(FontWeight.Bold).fontColor('#1A1A2E')
        Blank()
        Text('+ æ–°å»º').fontSize(14).fontColor('#667EEA').fontWeight(FontWeight.Medium)
          .onClick(() => { router.pushUrl({ url: 'pages/Testament' }) })
      }
      .width('100%').height(56).padding({ left: 16, right: 16 })

      if (this.testaments.length === 0) {
        Column({ space: 12 }) {
          Text('ğŸ“').fontSize(48)
          Text('è¿˜æ²¡æœ‰é—è¨€').fontSize(16).fontColor('#9CA3AF')
          Text('è®°å½•æ‚¨çš„å¿ƒæ„¿ä¸å˜±æ‰˜').fontSize(13).fontColor('#C0C4CC')
        }
        .width('100%').layoutWeight(1).justifyContent(FlexAlign.Center)
      } else {
        List({ space: 10 }) {
          ForEach(this.testaments, (t: TestamentItem) => {
            ListItem() {
              Column({ space: 8 }) {
                Row({ space: 8 }) {
                  Text(this.typeLabel(t.testamentType))
                    .fontSize(11).fontColor(this.typeColor(t.testamentType))
                    .padding({ left: 8, right: 8, top: 3, bottom: 3 })
                    .backgroundColor(this.typeColor(t.testamentType) + '1A').borderRadius(6)
                  Blank()
                  Row({ space: 4 }) {
                    Text(t.unlockStatus === 1 ? 'ğŸ”“' : 'ğŸ”’').fontSize(14)
                    Text(t.unlockStatus === 1 ? 'å·²è§£é”' : 'é”å®šä¸­')
                      .fontSize(11).fontColor(t.unlockStatus === 1 ? '#10B981' : '#9CA3AF')
                  }
                }
                Text(t.title).fontSize(16).fontWeight(FontWeight.Medium).fontColor('#1A1A2E')
                Text(t.createTime?.substring(0, 10) || '')
                  .fontSize(11).fontColor('#C0C4CC')
              }
              .width('100%').padding(16)
              .backgroundColor(Color.White).borderRadius(16)
              .shadow({ radius: 6, color: '#0000000D', offsetX: 0, offsetY: 3 })
            }
          })
        }
        .padding({ left: 16, right: 16, top: 8 })
        .layoutWeight(1)
      }
    }
    .width('100%').height('100%').backgroundColor('#F8F9FE')
  }
}

// â”€â”€â”€ æˆ‘çš„ Tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@Component
struct ProfileTab {
  @State userName: string = 'ç”¨æˆ·'
  @State phone: string = ''
  @State realNameStatus: number = 0

  aboutToAppear(): void {
    this.loadUser()
  }

  async loadUser(): Promise<void> {
    try {
      const str = await load(getContext(this) as Context, STORAGE_USER)
      if (str) {
        const u = JSON.parse(str) as Record<string, ESObject>
        this.userName = (u['realName'] as string) || 'ç”¨æˆ·'
        const rawPhone = (u['phone'] as string) || ''
        this.phone = rawPhone.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2')
        this.realNameStatus = (u['realNameStatus'] as number) || 0
      }
    } catch (e) {}
  }

  statusLabel(s: number): string {
    const labels: string[] = ['æœªå®å', 'å®¡æ ¸ä¸­', 'å·²å®å', 'å®¡æ ¸å¤±è´¥']
    return s >= 0 && s < labels.length ? labels[s] : 'æœªçŸ¥'
  }

  async logout(): Promise<void> {
    await clear(getContext(this) as Context)
    router.replaceUrl({ url: 'pages/Login' })
  }

  build() {
    Scroll() {
      Column({ space: 0 }) {
        // ç”¨æˆ·å¡ç‰‡
        Column({ space: 12 }) {
          Stack() {
            Circle().width(72).height(72)
              .linearGradient({ angle: 135, colors: [['#667EEA', 0], ['#764BA2', 1]] })
            Text(this.userName.charAt(0))
              .fontSize(32).fontColor(Color.White).fontWeight(FontWeight.Bold)
          }
          Column({ space: 4 }) {
            Text(this.userName)
              .fontSize(20).fontWeight(FontWeight.Bold).fontColor(Color.White)
            Text(this.phone).fontSize(13).fontColor('#E0D7FF')
            Row({ space: 4 }) {
              Text(this.realNameStatus === 2 ? 'âœ“' : 'â€¢')
                .fontSize(11).fontColor(this.realNameStatus === 2 ? '#10B981' : '#F59E0B')
              Text(this.statusLabel(this.realNameStatus))
                .fontSize(11).fontColor(this.realNameStatus === 2 ? '#86EFAC' : '#FDE68A')
            }
          }
        }
        .width('100%')
        .padding({ top: 40, bottom: 32 })
        .linearGradient({ angle: 135, colors: [['#667EEA', 0], ['#764BA2', 1]] })
        .alignItems(HorizontalAlign.Center)

        // èœå•åˆ—è¡¨
        Column({ space: 10 }) {
          ForEach([
            { icon: 'ğŸ‘¤', label: 'ä¸ªäººèµ„æ–™',   page: 'pages/Profile' } as MenuItem,
            { icon: 'ğŸŒ³', label: 'å®¶æ—å…³ç³»æ ‘', page: 'pages/FamilyTree' } as MenuItem,
            { icon: 'ğŸ›ï¸', label: 'æŒ½è”çºªå¿µå¢™', page: 'pages/EulogyWall' } as MenuItem,
            { icon: 'ğŸ›¡ï¸', label: 'å®åè®¤è¯',   page: '' } as MenuItem,
            { icon: 'âš™ï¸', label: 'è®¾ç½®',       page: '' } as MenuItem
          ], (item: MenuItem) => {
            Row({ space: 14 }) {
              Text(item.icon).fontSize(20)
              Text(item.label).fontSize(15).fontColor('#1A1A2E').layoutWeight(1)
              Text('â€º').fontSize(18).fontColor('#C0C4CC')
            }
            .width('100%').height(52).padding({ left: 16, right: 16 })
            .backgroundColor(Color.White).borderRadius(14)
            .shadow({ radius: 2, color: '#0000000A', offsetX: 0, offsetY: 1 })
            .onClick(() => {
              if (item.page) { router.pushUrl({ url: item.page }) }
            })
          })

          Button('é€€å‡ºç™»å½•', { type: ButtonType.Normal })
            .width('100%').height(48)
            .fontSize(15).fontColor('#EF4444')
            .backgroundColor('#FEF2F2').borderRadius(14)
            .onClick(() => { this.logout() })
        }
        .width('100%').padding({ left: 16, right: 16, top: 16, bottom: 32 })
      }
    }
    .width('100%').height('100%').backgroundColor('#F8F9FE')
  }
}

// â”€â”€â”€ ä¸»å¯¼èˆª â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@Entry
@Component
struct Index {
  @State currentTab: number = 0
  private readonly tabTitles: string[] = ['é¦–é¡µ', 'å…³ç³»', 'é—è¨€', 'æˆ‘çš„']
  private readonly tabIcons: string[] = ['ğŸ ', 'ğŸŒ³', 'ğŸ“', 'ğŸ‘¤']

  build() {
    Column() {
      // å†…å®¹åŒº â€”â€” Builder è¿”å› voidï¼Œå¿…é¡»åŒ…åœ¨å®¹å™¨é‡Œæ‰èƒ½åŠ  layoutWeight
      Column() {
        if (this.currentTab === 0) { DashboardTab() }
        else if (this.currentTab === 1) { RelationsTab() }
        else if (this.currentTab === 2) { TestamentTab() }
        else { ProfileTab() }
      }
      .layoutWeight(1)
      .width('100%')

      // åº•éƒ¨å¯¼èˆª
      Row() {
        ForEach(this.tabTitles, (title: string, idx: number) => {
          Column({ space: 3 }) {
            Text(this.tabIcons[idx])
              .fontSize(this.currentTab === idx ? 24 : 22)
              .fontColor(this.currentTab === idx ? '#667EEA' : '#9CA3AF')
            Text(title)
              .fontSize(10)
              .fontColor(this.currentTab === idx ? '#667EEA' : '#9CA3AF')
              .fontWeight(this.currentTab === idx ? FontWeight.Medium : FontWeight.Normal)
          }
          .layoutWeight(1).height(56)
          .justifyContent(FlexAlign.Center)
          .onClick(() => { this.currentTab = idx })
        })
      }
      .width('100%')
      .backgroundColor(Color.White)
      .border({ width: { top: 1 }, color: '#F0F0F0' })
    }
    .width('100%').height('100%').backgroundColor('#F8F9FE')
  }
}
