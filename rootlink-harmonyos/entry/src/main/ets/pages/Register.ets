import router from '@ohos.router'
import { post } from '../utils/HttpUtil'
import { save } from '../utils/StorageUtil'
import { toastErr, toast } from '../utils/ToastUtil'
import { STORAGE_TOKEN, STORAGE_USER } from '../utils/Constants'

interface RegisterResp {
  token: string
  userInfo: object
}

@Entry
@Component
struct Register {
  @State phone: string = ''
  @State password: string = ''
  @State confirm: string = ''
  @State realName: string = ''
  @State loading: boolean = false

  async doRegister(): Promise<void> {
    if (!this.realName) { toastErr('è¯·è¾“å…¥çœŸå®å§“å'); return }
    if (!this.phone || this.phone.length !== 11) { toastErr('æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®'); return }
    if (this.password.length < 6) { toastErr('å¯†ç è‡³å°‘6ä½'); return }
    if (this.password !== this.confirm) { toastErr('ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´'); return }
    this.loading = true
    try {
      const res = await post<RegisterResp>('/v1/auth/register', {
        phone: this.phone, password: this.password,
        realName: this.realName, confirmPassword: this.confirm
      })
      await save(getContext(this) as Context, STORAGE_TOKEN, res.token)
      await save(getContext(this) as Context, STORAGE_USER, JSON.stringify(res.userInfo))
      toast('æ³¨å†ŒæˆåŠŸï¼Œæ¬¢è¿åŠ å…¥ RootLinkï¼')
      router.replaceUrl({ url: 'pages/Index' })
    } catch (e) {
      toastErr((e as Error).message)
    } finally {
      this.loading = false
    }
  }

  @Builder FieldItem(icon: string, hint: string, val: string, type: InputType,
    cb: (v: string) => void) {
    Row({ space: 12 }) {
      Text(icon).fontSize(18)
      TextInput({ placeholder: hint, text: val })
        .type(type).fontSize(15).fontColor('#1A1A2E')
        .caretColor('#667EEA')
        .backgroundColor(Color.Transparent).borderWidth(0)
        .layoutWeight(1)
        .onChange(cb)
    }
    .width('100%').height(52)
    .backgroundColor('#F8F9FE').borderRadius(12)
    .padding({ left: 16, right: 16 })
  }

  build() {
    Column() {
      Row() {
        Text('â†').fontSize(22).fontColor('#1A1A2E').onClick(() => { router.back() })
        Text('åˆ›å»ºè´¦å·').fontSize(18).fontWeight(FontWeight.Bold).fontColor('#1A1A2E')
          .layoutWeight(1).textAlign(TextAlign.Center)
        Text('').width(32)
      }
      .width('100%').height(56).padding({ left: 16, right: 16 })

      Scroll() {
        Column({ space: 14 }) {
          Text('å¡«å†™åŸºæœ¬ä¿¡æ¯ï¼Œå¼€å§‹è®°å½•æ‚¨çš„å®¶æ—æ•…äº‹')
            .fontSize(13).fontColor('#9CA3AF').margin({ top: 8, bottom: 16 })

          // å§“å
          Row({ space: 12 }) {
            Text('ğŸ‘¤').fontSize(18)
            TextInput({ placeholder: 'çœŸå®å§“å', text: this.realName })
              .type(InputType.Normal).fontSize(15).fontColor('#1A1A2E')
              .caretColor('#667EEA').backgroundColor(Color.Transparent)
              .borderWidth(0).layoutWeight(1)
              .onChange((v: string) => { this.realName = v })
          }
          .width('100%').height(52).backgroundColor('#F8F9FE')
          .borderRadius(12).padding({ left: 16, right: 16 })

          // æ‰‹æœºå·
          Row({ space: 12 }) {
            Text('ğŸ“±').fontSize(18)
            TextInput({ placeholder: 'æ‰‹æœºå·', text: this.phone })
              .type(InputType.PhoneNumber).fontSize(15).fontColor('#1A1A2E')
              .caretColor('#667EEA').backgroundColor(Color.Transparent)
              .borderWidth(0).layoutWeight(1)
              .onChange((v: string) => { this.phone = v })
          }
          .width('100%').height(52).backgroundColor('#F8F9FE')
          .borderRadius(12).padding({ left: 16, right: 16 })

          // å¯†ç 
          Row({ space: 12 }) {
            Text('ğŸ”‘').fontSize(18)
            TextInput({ placeholder: 'è®¾ç½®å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰', text: this.password })
              .type(InputType.Password).fontSize(15).fontColor('#1A1A2E')
              .caretColor('#667EEA').backgroundColor(Color.Transparent)
              .borderWidth(0).layoutWeight(1)
              .onChange((v: string) => { this.password = v })
          }
          .width('100%').height(52).backgroundColor('#F8F9FE')
          .borderRadius(12).padding({ left: 16, right: 16 })

          // ç¡®è®¤å¯†ç 
          Row({ space: 12 }) {
            Text('ğŸ”’').fontSize(18)
            TextInput({ placeholder: 'ç¡®è®¤å¯†ç ', text: this.confirm })
              .type(InputType.Password).fontSize(15).fontColor('#1A1A2E')
              .caretColor('#667EEA').backgroundColor(Color.Transparent)
              .borderWidth(0).layoutWeight(1)
              .onChange((v: string) => { this.confirm = v })
          }
          .width('100%').height(52).backgroundColor('#F8F9FE')
          .borderRadius(12).padding({ left: 16, right: 16 })

          Button(this.loading ? 'æ³¨å†Œä¸­...' : 'åˆ›å»ºè´¦å·', { type: ButtonType.Normal })
            .width('100%').height(52)
            .fontSize(16).fontWeight(FontWeight.Medium).fontColor(Color.White)
            .linearGradient({ angle: 90, colors: [['#667EEA', 0], ['#764BA2', 1]] })
            .borderRadius(12).enabled(!this.loading)
            .onClick(() => { this.doRegister() })
            .margin({ top: 8 })

          Row({ space: 4 }) {
            Text('å·²æœ‰è´¦å·ï¼Ÿ').fontSize(13).fontColor('#9CA3AF')
            Text('è¿”å›ç™»å½•').fontSize(13).fontColor('#667EEA').fontWeight(FontWeight.Medium)
              .onClick(() => { router.back() })
          }
          .width('100%').justifyContent(FlexAlign.Center)
        }
        .width('100%').padding({ left: 28, right: 28, bottom: 40 })
      }
      .layoutWeight(1)
    }
    .width('100%').height('100%').backgroundColor(Color.White)
  }
}
