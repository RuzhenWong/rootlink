/**
 * 关系链工具 - v2.0
 *
 * 链的语义（重要！）：
 *   chain = A 视角，描述「对方（B）是我（A）的什么人」
 *   例：chain=["姐"] → 对方是我的姐姐 → 即我是对方的弟弟/妹妹
 *
 * 注意：前端 UI 应展示「对方是我的XX」，而非「我是对方的XX」
 * 两者正好相反，历史 Bug 来源于此混淆。
 */

// ── 单步称谓 ──────────────────────────────────────────
const ONE_STEP = {
  '父': '父亲', '母': '母亲',
  '子': '儿子', '女': '女儿',
  '配偶': '配偶',
  '哥': '哥哥', '弟': '弟弟', '姐': '姐姐', '妹': '妹妹',
}

// ── 两步称谓 ──────────────────────────────────────────
const TWO_STEP = {
  // 祖父母辈
  '父,父': '爷爷', '父,母': '奶奶',
  '母,父': '外公', '母,母': '外婆',
  // 父辈旁系
  '父,哥': '伯父', '父,弟': '叔叔',
  '父,姐': '姑姑', '父,妹': '姑姑',
  '母,哥': '舅舅', '母,弟': '舅舅',
  '母,姐': '姨妈', '母,妹': '姨妈',
  // 父母的配偶
  '父,配偶': '继母', '母,配偶': '继父',
  // 子辈
  '子,子': '孙子', '子,女': '孙女',
  '女,子': '外孙', '女,女': '外孙女',
  // 子女的配偶
  '子,配偶': '儿媳', '女,配偶': '女婿',
  // 配偶的父母
  '配偶,父': '岳父/公公', '配偶,母': '岳母/婆婆',
  // 配偶的兄弟姐妹
  '配偶,哥': '大舅子/大伯子', '配偶,弟': '小舅子/小叔子',
  '配偶,姐': '大姨子/大姑子', '配偶,妹': '小姨子/小姑子',
  // 配偶的子女（继子女）
  '配偶,子': '继子', '配偶,女': '继女',
  // 兄弟姐妹的子女
  '哥,子': '侄子', '哥,女': '侄女',
  '弟,子': '侄子', '弟,女': '侄女',
  '姐,子': '外甥', '姐,女': '外甥女',
  '妹,子': '外甥', '妹,女': '外甥女',
  // 兄弟姐妹的配偶
  '哥,配偶': '嫂子', '弟,配偶': '弟媳',
  '姐,配偶': '姐夫', '妹,配偶': '妹夫',
}

// ── 三步称谓 ──────────────────────────────────────────
const THREE_STEP = {
  // 曾祖父母
  '父,父,父': '太爷爷', '父,父,母': '太奶奶',
  '母,母,父': '太外公', '母,母,母': '太外婆',
  '母,父,父': '太外公', '母,父,母': '太外婆',
  '父,母,父': '太外公', '父,母,母': '太外婆',
  // 重孙子女
  '子,子,子': '重孙子', '子,子,女': '重孙女',
  '女,子,子': '外曾孙', '女,子,女': '外曾孙女',
  // 孙媳/孙女婿
  '子,子,配偶': '孙媳', '子,女,配偶': '孙女婿',
  // 亲家
  '子,配偶,父': '亲家公', '子,配偶,母': '亲家母',
  '女,配偶,父': '亲家公', '女,配偶,母': '亲家母',
  // 配偶家族
  '配偶,父,父': '配偶的爷爷', '配偶,父,母': '配偶的奶奶',
  '配偶,母,父': '配偶的外公', '配偶,母,母': '配偶的外婆',
  '配偶,父,哥': '配偶的伯父', '配偶,父,弟': '配偶的叔叔',
  '配偶,父,姐': '配偶的姑姑', '配偶,父,妹': '配偶的姑姑',
  '配偶,母,哥': '配偶的舅舅', '配偶,母,弟': '配偶的舅舅',
  '配偶,母,姐': '配偶的姨妈', '配偶,母,妹': '配偶的姨妈',
  // 堂兄弟姐妹（父系）
  '父,哥,子': '堂兄', '父,哥,女': '堂姐',
  '父,弟,子': '堂弟', '父,弟,女': '堂妹',
  '父,姐,子': '表哥/表弟', '父,姐,女': '表姐/表妹',
  '父,妹,子': '表哥/表弟', '父,妹,女': '表姐/表妹',
  // 表兄弟姐妹（母系）
  '母,哥,子': '表哥/表弟', '母,哥,女': '表姐/表妹',
  '母,弟,子': '表哥/表弟', '母,弟,女': '表姐/表妹',
  '母,姐,子': '表哥/表弟', '母,姐,女': '表姐/表妹',
  '母,妹,子': '表哥/表弟', '母,妹,女': '表姐/表妹',
  // 叔伯的配偶
  '父,哥,配偶': '伯母', '父,弟,配偶': '婶婶',
  '父,姐,配偶': '姑父', '父,妹,配偶': '姑父',
  '母,哥,配偶': '舅妈', '母,弟,配偶': '舅妈',
  '母,姐,配偶': '姨父', '母,妹,配偶': '姨父',
}

// ── 四步称谓 ──────────────────────────────────────────
const FOUR_STEP = {
  '父,父,父,父': '高祖父',
  '父,父,父,母': '高祖母',
  // 爷爷的哥哥弟弟的儿子女儿 → 直称叔叔姑姑
  '父,父,哥,子': '叔叔（堂叔）', '父,父,哥,女': '姑姑（堂姑）',
  '父,父,弟,子': '叔叔（堂叔）', '父,父,弟,女': '姑姑（堂姑）',
  // 奶奶的兄弟/姐妹的子女 → 表叔/表姑
  '父,母,哥,子': '表叔', '父,母,哥,女': '表姑',
  '父,母,弟,子': '表叔', '父,母,弟,女': '表姑',
  '父,母,姐,子': '表叔', '父,母,姐,女': '表姑',
  '父,母,妹,子': '表叔', '父,母,妹,女': '表姑',
}

/**
 * 将关系链转换为中文称谓
 */
export function chainToName(chain) {
  if (!chain || chain.length === 0) return ''
  const key = chain.join(',')
  if (chain.length === 1) return ONE_STEP[key] || '亲属'
  if (chain.length === 2) return TWO_STEP[key] || '亲属'
  if (chain.length === 3) return THREE_STEP[key] || '亲属'
  if (chain.length === 4) return FOUR_STEP[key] || '亲属'
  return '亲属'
}

/**
 * 描述文字：「对方是我的 XX」
 * 这是链的本义，用于申请人自己看
 */
export function chainToDescription(chain) {
  if (!chain || chain.length === 0) return ''
  const lbl = {
    '父': '父亲', '母': '母亲', '子': '儿子', '女': '女儿',
    '配偶': '配偶', '哥': '哥哥', '弟': '弟弟', '姐': '姐姐', '妹': '妹妹',
  }
  const name = chainToName(chain)
  const path = chain.map(s => lbl[s] || s).join(' → ')
  return `对方是我的「${name}」（路径：${path}）`
}

/**
 * 根据已选步骤，返回下一步可选项
 * 最大支持 4 步
 */
export function nextStepOptions(prev) {
  const all = [
    { value: '父', label: '父亲' }, { value: '母', label: '母亲' },
    { value: '子', label: '儿子' }, { value: '女', label: '女儿' },
    { value: '配偶', label: '配偶' },
    { value: '哥', label: '哥哥' }, { value: '弟', label: '弟弟' },
    { value: '姐', label: '姐姐' }, { value: '妹', label: '妹妹' },
  ]
  if (prev.length === 0) return all
  if (prev.length >= 4) return []
  const last = prev[prev.length - 1]
  const rules = {
    '父': ['父', '母', '哥', '弟', '姐', '妹', '配偶'],
    '母': ['父', '母', '哥', '弟', '姐', '妹', '配偶'],
    '子': ['子', '女', '配偶'],
    '女': ['子', '女', '配偶'],
    '配偶': ['父', '母', '哥', '弟', '姐', '妹', '子', '女'],
    '哥': ['子', '女', '配偶'],
    '弟': ['子', '女', '配偶'],
    '姐': ['子', '女', '配偶'],
    '妹': ['子', '女', '配偶'],
  }
  // 防止无意义链（如 父,子 = 兄弟，但通过更直接的方式选择更好）
  const key = prev.join(',')
  // 过滤掉已确认是无效路径的情况
  const allowed = rules[last] || []
  return all.filter(o => allowed.includes(o.value))
}

// 兼容旧代码
export const UP_OPTIONS = ['父', '母']
export const DOWN_OPTIONS = ['子', '女']
export const SIBLING_OPTIONS = ['哥', '弟', '姐', '妹']
export const CONNECTION_OPTIONS = ['直属', '伯伯', '叔叔', '姑姑', '舅舅', '姨妈']
